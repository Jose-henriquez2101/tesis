<div class="content">
<div class="container mt-4">
  <h2>Panel de Control - Sesiones VR</h2>
  <p class="capacitador-info">
    ğŸ‘¤ Capacitador: <strong>{{ capacitadorNombre }}</strong>
    <span class="id-tag">ID {{ capacitadorId }}</span>
  </p>
Â  Â  

    <!-- Mensajes de estado -->
    <div *ngIf="loading" class="alert alert-info">Cargando datos...</div>
Â    <div *ngIf="errorMsg" class="alert alert-danger">{{ errorMsg }}</div>
Â    <div *ngIf="successMsg" class="alert alert-success">{{ successMsg }}</div>

Â  Â  <!-- Interfaz de AsignaciÃ³n de SesiÃ³n (se muestra cuando hay una estaciÃ³n Unity en espera) -->
Â  Â  <div *ngIf="pendingStationId; else esperando" class="card-moderno fade-in">

Â  Â  Â  <h3 class="section-title">Asignar SesiÃ³n a EstaciÃ³n VR</h3>

Â  Â  Â  <div class="info-grid mb-4">
Â  Â  Â  Â  <div class="info-item">
Â  Â  Â  Â  Â  <span>EstaciÃ³n VR en Espera:</span>
Â  Â  Â  Â  Â  <strong>{{ pendingStationId }}</strong>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="select-box">
Â  Â  Â  Â  <label>Seleccionar Bombero a Evaluar:</label>
Â  Â  Â  Â  <select [(ngModel)]="bomberoSeleccionadoId" name="bomberoSelect">
Â  Â  Â  Â  Â  <option [ngValue]="null" disabled>-- Elija un Bombero --</option>
Â  Â  Â  Â  Â  <option *ngFor="let b of bomberosDisponibles" [ngValue]="b.ID_Bombero">
Â  Â  Â  Â  Â  Â  {{ b.NombreCompleto }} (RUT: {{ b.Rut }})
Â  Â  Â  Â  Â  </option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

Â  Â  Â  <div class="select-box">
Â  Â  Â  Â  <label>Seleccionar Escenario de Entrenamiento:</label>
Â  Â  Â  Â  <select [(ngModel)]="escenarioSeleccionadoId" name="escenarioSelect">
Â  Â  Â  Â  Â  <option [ngValue]="null" disabled>-- Elija un Escenario --</option>
Â  Â  Â  Â  Â  <option *ngFor="let esc of escenarios" [ngValue]="esc.id_Escenario">
Â  Â  Â  Â  Â  Â  {{ esc.NombreEscenario }}
Â  Â  Â  Â  Â  </option>
Â  Â  Â  Â  </select>
Â  Â  Â  </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="grabarCheck" [(ngModel)]="grabarAudio" name="grabarAudio">
        <label class="form-check-label" for="grabarCheck">Grabar audio durante la simulaciÃ³n</label>
      </div>

Â  Â  Â  <button 
Â  Â  Â  Â  class="btn-modern"
Â  Â  Â  Â  (click)="iniciarSimulacion()"
Â  Â  Â  Â  [disabled]="!bomberoSeleccionadoId || !escenarioSeleccionadoId || loading"
Â  Â  Â  >
Â  Â  Â  Â  {{ loading ? 'Enviando Comando...' : 'Asignar Bombero e Iniciar SimulaciÃ³n' }}
Â  Â  Â  </button>

Â  Â  </div>

Â  Â  <!-- Plantilla de espera -->
Â  Â  <ng-template #esperando>
Â  Â  Â  <div class="waiting-card fade-in">
Â  Â  Â  Â  <h3>â³ Esperando seÃ±al de la estaciÃ³n VR...</h3>
Â  Â  Â  Â  <p>
Â  Â  Â  Â  Â  El bombero debe presionar "Iniciar SimulaciÃ³n" en el visor.
Â  Â  Â  Â  </p>
Â  Â  Â  </div>
Â  Â  </ng-template>

    <!-- Lista de sesiones pasadas -->
    <div class="card-moderno mt-4">
      <h3 class="section-title">Sesiones Pasadas</h3>
      <p class="small text-muted">Haz clic en una sesiÃ³n para ver los detalles.</p>

      <div *ngIf="(sesiones?.length || 0) === 0" class="alert alert-info">
        No hay sesiones registradas aÃºn.
      </div>

      <div class="sesiones-list" *ngIf="(sesiones?.length || 0) > 0">
        <div class="list-group">
          <button type="button" class="list-group-item list-group-item-action"
                  *ngFor="let s of sesiones" (click)="selectedSesion = (selectedSesion === s ? null : s)">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">SesiÃ³n {{ s.ID_Sesion || s.id || 'â€”' }}</h5>
              <small class="text-muted">{{ (s.Fecha || s.fecha || s.createdAt) ? ((s.Fecha || s.fecha || s.createdAt) | date:'dd/MM/yyyy HH:mm') : '' }}</small>
            </div>
            <p class="mb-1">Escenario: {{ s.escenario?.NombreEscenario || s.nombreEscenario || 'N/D' }}</p>
            <small>Participante: {{ s.bombero?.NombreCompleto || s.nombreBombero || 'N/D' }}</small>
          </button>
        </div>
      </div>

      <div *ngIf="selectedSesion" class="mt-3">
        <h5>Detalle SesiÃ³n</h5>
        <p><strong>Escenario:</strong> {{ selectedSesion.escenario?.NombreEscenario || selectedSesion.nombreEscenario }}</p>
        <p><strong>Bombero:</strong> {{ selectedSesion.bombero?.NombreCompleto || selectedSesion.nombreBombero }}</p>
        <p *ngIf="selectedSesion.Fecha || selectedSesion.fecha || selectedSesion.createdAt"><strong>Fecha:</strong> {{ (selectedSesion.Fecha || selectedSesion.fecha || selectedSesion.createdAt) | date:'dd/MM/yyyy HH:mm' }}</p>
        
        <!-- Reproductor de audio si existe en BD (se solicita al backend) -->
        <div>
          <h6>GrabaciÃ³n de la sesiÃ³n</h6>
          <div class="mb-2">
            <button class="btn btn-sm btn-outline-primary" (click)="loadAndPlayAudio(selectedSesion)">Cargar y Reproducir</button>
            <span *ngIf="loading" class="text-muted"> Cargando audio...</span>
          </div>
          <audio id="audioPlayer" controls *ngIf="audioUrl" [src]="audioUrl"></audio>
        </div>

        <!-- Formulario para subir audio (Ãºtil para pruebas desde UI o para reemplazar) -->
        <div class="mt-2">
          <label class="form-label">Subir/Actualizar audio de la sesiÃ³n (prueba)</label>
          <input type="file" accept="audio/*" (change)="onAudioFileSelected($event)" />
          <div class="mt-2">
            <button class="btn btn-sm btn-primary" (click)="uploadAudioForSelectedSesion()" [disabled]="loading || !audioFileToUpload">Subir audio</button>
          </div>
        </div>
      </div>
    </div>
</div>
</div>